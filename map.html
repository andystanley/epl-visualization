<!DOCTYPE html>
<html>

<head>
    <style>
        #map {
            height: 100%;
            width: 85%;
        }
        #panel {
            background-color: white;
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 15%;
            height: 100%;
            overflow-y: auto;
            text-align: center;
        }
        #collapse {
            position: absolute;
            width: 1.5%;
            min-width: 25px;
            left: 83.5%;
            top: 50%;
            font-size: 125%;
            border-radius: 8px;
        }
        #filter {
        	position: absolute;
        	top: 2%;
        	left: 40%;
        	width: 10%;
        	min-width: 105px;
        }
        img {
            position: absolute;
            top: 90%;
            left: 0.6%;
        }
        h3 {
            padding: 0px;
            margin: 0px;
        }
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <div id="panel"></div>
    <button id="collapse" onclick="collapsePanel()">-</button>
    <select id="filter" onchange="filterMarkers(this.value);">
	    <option value="">Filter by Club</option>
	    <option value="Arsenal">Arsenal</option>
	    <option value="Bournemouth">Bournemouth</option>
	    <option value="Brighton">Brighton</option>
		<option value="Burnley">Burnley</option>
		<option value="Chelsea">Chelsea</option>
	    <option value="Crystal Palace">Crystal Palace</option>
	    <option value="Everton">Everton</option>
		<option value="Huddersfield">Huddersfield</option>
		<option value="Leicester City">Leicester City</option>
	    <option value="Liverpool">Liverpool</option>
	    <option value="Manchester City">Manchester City</option>
		<option value="Manchester United">Manchester United</option>
		<option value="Newcastle United">Newcastle United</option>
	    <option value="Southampton">Southampton</option>
	    <option value="Stoke City">Stoke City</option>
		<option value="Swansea">Swansea</option>
		<option value="Tottenham">Tottenham</option>
	    <option value="Watford">Watford</option>
	    <option value="West Brom">West Brom</option>
		<option value="West Ham">West Ham</option>
	</select>
    <a href="https://github.com/andystanley/EPL-Players-Nationality">
    <img src="logos/github.png">
        <script>
            var map;
            var infoWindow;
            var allMarkers = [];
            var button = document.getElementById('collapse');
            var panel = document.getElementById('panel');
            var mapStyle = document.getElementById('map').style;

            panel.innerHTML = '<h3>Player Viewer<h3><br>';
            panel.innerHTML += '<i>Click on a club in a country to view all players from that country.<i><br><br>';

            function initMap() {
                map = new google.maps.Map(document.getElementById('map'), {
                    zoom: 4,
                    minZoom: 3,
                    maxZoom: 5,
                    center: new google.maps.LatLng(45.9, 24.9),
                    mapTypeId: 'roadmap'
                });

                infoWindow = new google.maps.InfoWindow();

                // Create a <script> tag and set the USGS URL as the source.
                var script = document.createElement('script');
                // This example uses a local copy of the GeoJSON stored atepl.js
                // http://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/2.5_week.geojsonp
                script.src = 'epl_data.js';
                document.getElementsByTagName('head')[0].appendChild(script);
            }

            // Loop through the results array and place a marker for each
            // set of coordinates.
            window.eqfeed_callback = function(results) {
                for (var i = 0; i < results.features.length; i++) {
                    // Get the player properties
                    var name = results.features[i].properties.name;
                    var club = results.features[i].properties.club;
                    var nationality = results.features[i].properties.nationality;
                    var age = results.features[i].properties.age;
                    var role = results.features[i].properties.position;
                    var coords = results.features[i].geometry.coordinates;

                    // Set up the players location
                    var latLng = new google.maps.LatLng(coords[1], coords[0]);

                    // Create the marker icon
                    var icon = {
                        url: 'logos/' + club + '.png', // url
                        scaledSize: new google.maps.Size(40, 40), // scaled size
                        origin: new google.maps.Point(0, 0), // origin
                        anchor: new google.maps.Point(20, 20),
                        labelOrigin: new google.maps.Point(20, 50) // anchor
                    }

                    // Create the marker label
                    var label = {
                        fontSize: '0px',
                        text: '.' // Hide the name from appearing as a label
                    }

                    // Create a marker
                    var marker = new google.maps.Marker({
                        position: latLng,
                        map: map,
                        icon: icon,
                        label: label,
                        name: name,
                        club: club,
                        nationality: nationality,
                        age: age,
                        role: role
                    });

                    // Add the marker to the array of all the markers
                    allMarkers.push(marker);

                    // Trigger when the map is fully loaded
                    google.maps.event.addListenerOnce(map, 'idle', function() {
                        var n = 1;  // i + 1
                        var players = 1;  // Counts the number of players in a country.  There must be a minimum of 1 player, so the variable is initialized to 1

                        // Loop through all the markers
                        for (var i = 0; i < allMarkers.length; i++) {
                        	var marker = allMarkers[i];
                        	var nextMarker = allMarkers[n];
                        	var nation = results.features[i].properties.nationality;
                        	// Compare the elements and if they do not match, set the label for the last element and reset the player count
                        	if (nextMarker.nationality !== nation) {
                        		marker.setLabel(players.toString());
                        	    players = 0;
                        	}
                        	// If the end of the loop has been reached, print out the last element and exit
                        	if ((n+1) === allMarkers.length) {  
                        		marker.setLabel((players + 1).toString());  
								break;  // Exit the loop
                        	}
                        	players++;
                        	n++;
                        }
					});

                    marker.addListener('click', function() {
                        var nat = this.nationality;
                        var numOfPlayers = 0;

                        panel.innerHTML = '<h3>Player Viewer<h3><br>';
                        panel.innerHTML += '<i>Click on a club in a country to view all players from that country.<i><br><br>';
                        panel.innerHTML += '<b>' + nat + ' Players' + '<b>' + '<br>';

                        // Print out the markers by nationality in the side panel
                        for (var i = 0; i < allMarkers.length; i++) {
                        	var marker = allMarkers[i];
                            if (marker.nationality === nat) {
                                panel.innerHTML += marker.name + ', ' +
                                    marker.age + ', ' +
                                    marker.role + ', ' +
                                    marker.club + '<br>';
                                numOfPlayers += 1;
                            }
                        }
                        if (numOfPlayers === 1) {
                            infoWindow.setContent(numOfPlayers.toString() + ' ' + nat + ' Player');
                        } else {
                            infoWindow.setContent(numOfPlayers.toString() + ' ' + nat + ' Players');
                        }
                        infoWindow.open(map, this);
                    });

                    // Add a listener for when the zoom is changed
                    map.addListener('zoom_changed', function() {
                        // For every marker, dynamically change the icon size based on the current zoom level
                        for (var i = 0; i < allMarkers.length; i++) {
                        	var marker = allMarkers[i];
                            var size = map.getZoom() * 10;
                            var pointX = 20;
                            var pointY = 50;

                            if (map.getZoom() > 4) {
                            	pointX += 5;
								pointY += 10;
                            }
                            else if (map.getZoom() < 4) {
								pointX -= 5;
								pointY -= 10;
                            }

                            // Set the size of the icon
                            marker.icon.scaledSize = new google.maps.Size(size, size);
                            marker.icon.size = new google.maps.Size(size, size);

                            // Set the label origin
                            marker.icon.labelOrigin = new google.maps.Point(pointX, pointY);

                            // Set all the markers on the map
                            marker.setMap(map);
                        }
                    });
                }
            }

            function collapsePanel() {
                if (button.innerHTML === "-") {
                    button.innerHTML = "+";
                    button.style.left = "96%";
                    panel.style.color = "white";
                    panel.style.overflow = "hidden";
                    panel.style.width = "2%";
                    mapStyle.width = "98%";
                } else {
                    button.innerHTML = "-";
                    button.style.left = "83.5%";
                    panel.style.color = "black";
                    panel.style.overflow = "initial";
                    panel.style.width = "15%";
                    mapStyle.width = "85%";
                }
                google.maps.event.trigger(map, 'resize');
            }

		   	filterMarkers = function (club) {
		   		debugger;
			    for (i = 0; i < allMarkers.length; i++) {
			        marker = allMarkers[i];
			        // If is same category or category not picked
			        if (marker.club === club || club.length === 0) {
			            marker.setVisible(true);
			        }
			        // Categories don't match 
			        else {
			            marker.setVisible(false);
			        }
		    	}
			}
        </script>
        <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCIczLmrse3tNr3S7EP2Hwk8gdMTAvjL9s&callback=initMap">
        </script>
</body>
</html>